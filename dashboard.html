<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>สถานะคดีปกครองโครงการเราชนะ</title>
    <!-- Chart.js สำหรับแผนภูมิ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ฟอนต์ Sarabun สำหรับภาษาไทย -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- ✅ NEW: Link to external CSS file -->
    <link rel="stylesheet" href="styles.css"> 
    
</head>
<body>
    <div id="app-container">
        <h1>สถานะคดีปกครองโครงการเราชนะ</h1>

        <!-- ---------------------------------------------------- -->
        <!-- 1. Login Form (แสดงเมื่อยังไม่ได้ล็อกอิน) -->
        <!-- ---------------------------------------------------- -->
        <div id="login-container">
            <h2>เข้าสู่ระบบเพื่อเข้าถึงข้อมูล</h2>
            <div id="login-error-message" class="error-message" style="display: none;"></div>
            
            <form id="login-form">
                <div>
                    <input type="password" id="password-input" required 
                           placeholder="กรอกรหัสผ่าน">
                </div>
                <button type="submit" id="login-button">
                    เข้าสู่ระบบ
                </button>
            </form>
        </div>


        <!-- ---------------------------------------------------- -->
        <!-- 2. Dashboard Content (แสดงเมื่อล็อกอินสำเร็จ) -->
        <!-- ---------------------------------------------------- -->
        <div id="data-display-container" style="display: none;">

            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                <button onclick="logout()" class="logout-button">ออกจากระบบ</button>
            </div>

            <p id="loading-message">กำลังโหลดข้อมูล...</p>

            <div class="dashboard" id="mainDashboard" style="display: none;">
                <div class="card card-total"><h2>คดีทั้งหมด</h2><p id="totalCases">0</p></div>
                <div class="card card-first"><h2>อยู่ระหว่างพิจารณาชั้นต้น</h2><p id="firstCourtCases">0</p></div>
                <div class="card card-supreme"><h2>อยู่ระหว่างพิจารณาสูงสุด</h2><p id="supremeCourtCases">0</p></div>
                <div class="card card-enforcement"><h2>อยู่ในขั้นตอนบังคับคดี</h2><p id="inExecutionCases">0</p></div>
                <div class="card card-complete"><h2>บังคับคดีเสร็จสิ้น</h2><p id="executionCompleteCases">0</p></div>
                <div class="card card-final"><h2>คำพิพากษาถึงที่สุด</h2><p id="finalCases">0</p></div>
            </div>

            <div class="content-area" id="mainContent" style="display: none; margin-top: 20px;">
                <div class="chart-container">
                    <h2>สัดส่วนสถานะคดีทั้งหมด</h2>
                    <div class="chart-wrapper">
                        <canvas id="caseStatusChart"></canvas>
                    </div>
                </div>
                
                <div class="table-container">
                    <h2 id="tableTitle">10 คดีล่าสุดที่อัปเดต</h2>
                    
                    <div class="search-bar">
                        <label for="caseSearch">ค้นหาเลขคดีดำ:</label>
                        <input type="text" id="caseSearch" placeholder="พิมพ์เลขคดีดำที่ต้องการค้นหา..." />
                    </div>
                    
                    <table id="casesTable">
                        <thead>
                            <tr>
                                <th>เลขคดีดำ</th>
                                <th>ปีคดีดำ</th> 
                                <th>ผู้ฟ้องคดี</th>
                                <th>ผลของคำพิพากษา</th>
                                <th>สถานะคดี</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // ✅ **สำคัญ:** Endpoint ของ Render Server ที่ปลอดภัย
        const API_URL = 'https://wewin-case-api.onrender.com/api/casestatus';
        const AUTH_KEY = 'Wewin_Auth_Key'; // Key สำหรับเก็บรหัสผ่านใน sessionStorage

        // Elements สำหรับ Login
        const loginContainer = document.getElementById('login-container');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error-message');

        // Elements สำหรับ Dashboard
        const dataDisplayContainer = document.getElementById('data-display-container');
        const loadingMessage = document.getElementById('loading-message');
        const mainDashboard = document.getElementById('mainDashboard');
        const mainContent = document.getElementById('mainContent');
        const caseSearchInput = document.getElementById('caseSearch');
        const casesTableBody = document.querySelector("#casesTable tbody");
        const tableTitle = document.getElementById('tableTitle');
        let chartInstance = null; // เก็บ instance ของ Chart.js

        let allCasesData = []; // เก็บข้อมูลคดีทั้งหมดที่ดึงมา

        // ----------------------------------------------------
        // 1. Logic การจัดการ UI State (Login/Loading/Data)
        // ----------------------------------------------------

        function showLogin(message = '') {
            dataDisplayContainer.style.display = 'none';
            loginContainer.style.display = 'block';
            passwordInput.value = '';
            loginButton.disabled = false;
            loginButton.textContent = 'เข้าสู่ระบบ';
            loadingMessage.style.display = 'none';
            
            if (message) {
                loginError.textContent = message;
                loginError.style.display = 'block';
            } else {
                loginError.style.display = 'none';
            }
        }
        
        function showLoading(message = 'กำลังโหลดข้อมูล...') {
            loginContainer.style.display = 'none';
            dataDisplayContainer.style.display = 'block';
            loadingMessage.textContent = message;
            loadingMessage.style.display = 'block';
            mainDashboard.style.display = 'none';
            mainContent.style.display = 'none';
        }

        function showDashboard() {
            loadingMessage.style.display = 'none';
            // Use 'grid' for mainDashboard and mainContent as defined in CSS
            mainDashboard.style.display = 'grid'; 
            mainContent.style.display = 'grid'; 
        }

        function logout() {
            sessionStorage.removeItem(AUTH_KEY);
            showLogin("ออกจากระบบแล้ว กรุณาเข้าสู่ระบบอีกครั้ง");
        }

        // ----------------------------------------------------
        // 2. Logic การล็อกอินและการดึงข้อมูล (Secure Fetch)
        // ----------------------------------------------------

        // ตรวจสอบสถานะการล็อกอินเมื่อโหลดหน้า
        document.addEventListener('DOMContentLoaded', () => {
            const storedPassword = sessionStorage.getItem(AUTH_KEY);
            if (storedPassword) {
                showLoading();
                loadData(storedPassword);
            } else {
                showLogin();
            }
        });

        // ดักจับการ Submit Form
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = passwordInput.value;
            
            loginButton.disabled = true;
            loginButton.textContent = 'กำลังตรวจสอบ...';
            loginError.style.display = 'none';
            
            showLoading(); // แสดงหน้าโหลด
            loadData(password, true); 
        });

        // 2.1 Core Fetch Logic (แยกจาก Retry Loop)
        async function fetchCaseData(password) {
            const res = await fetch(API_URL, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${password}`, // ส่งรหัสผ่านผ่าน Header
                    'Content-Type': 'application/json',
                }
            });

            if (res.status === 401) {
                throw new Error("Unauthorized");
            }
            
            if (!res.ok) {
                throw new Error(`API Error: ${res.status} ${res.statusText}`);
            }

            return res.json();
        }

        // 2.2 Retry Logic (เพื่อจัดการปัญหา Server Cold Start/Network ชั่วคราว)
        async function loadData(password, isLoginAttempt = false) {
            const MAX_RETRIES = 3;
            let attempt = 0;

            while (attempt < MAX_RETRIES) {
                attempt++;
                // Exponential backoff delay: 0s (initial), 2s, 4s (if needed)
                const delay = attempt === 1 ? 0 : Math.pow(2, attempt) * 500; 

                try {
                    if (attempt > 1) {
                         // หน่วงเวลาตาม backoff และแจ้งสถานะการ retry
                         showLoading(`กำลังพยายามเชื่อมต่อใหม่... (ครั้งที่ ${attempt}/${MAX_RETRIES})`);
                         await new Promise(resolve => setTimeout(resolve, delay));
                    }
                    
                    const data = await fetchCaseData(password);

                    if (isLoginAttempt) {
                        // ถ้าเป็นการล็อกอินครั้งแรกและสำเร็จ ให้บันทึกรหัสผ่านไว้
                        sessionStorage.setItem(AUTH_KEY, password);
                    }

                    // Success: Process data and show dashboard
                    processAndRenderDashboard(data.values); 
                    showDashboard(); 
                    return; // สำเร็จ, ออกจากลูป
                    
                } catch (error) {
                    if (error.message === "Unauthorized") {
                        // รหัสผ่านผิดพลาด (401) ไม่ต้อง retry
                        sessionStorage.removeItem(AUTH_KEY);
                        showLogin("รหัสผ่านไม่ถูกต้อง กรุณาลองใหม่");
                        return;
                    }
                    if (error.message.startsWith("API Error")) {
                        // Server ตอบกลับด้วยโค้ด Error อื่นๆ (เช่น 500) ไม่ต้อง retry
                        sessionStorage.removeItem(AUTH_KEY);
                        showLogin(`เกิดข้อผิดพลาดในการดึงข้อมูล: ${error.message}. โปรดตรวจสอบ Server Log.`);
                        return;
                    }
                    
                    // Network/Fetch error (e.g., server asleep or temporary network issue)
                    console.warn(`Fetch attempt ${attempt} failed (network issue or server cold start). Retrying...`, error);

                    if (attempt === MAX_RETRIES) {
                        // พยายามซ้ำครบจำนวนแล้ว
                        console.error("Fetch failed after all retries.");
                        sessionStorage.removeItem(AUTH_KEY);
                        showLogin(`ไม่สามารถเชื่อมต่อกับ Server ได้ (พยายาม ${MAX_RETRIES} ครั้ง) กรุณาตรวจสอบ Console Log และสถานะ Server.`);
                        return;
                    }
                }
            }
        }

        // ----------------------------------------------------
        // 3. Logic Dashboard 
        // ----------------------------------------------------

        /** * แปลงข้อมูลจาก Array of Arrays เป็น Array of Objects
         * โดยใช้ชื่อคอลัมน์จากแถวแรกเป็น key
         */
        function arrayToObjects(data) {
            if (!data || data.length < 2) return [];
            const headers = data[0].map(h => String(h || '').trim());
            const cases = [];
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                // Skip completely empty rows
                if (row.filter(cell => String(cell || '').trim() !== '').length === 0) continue; 
                
                const item = {};
                headers.forEach((header, j) => { item[header] = String(row[j] || '').trim(); });
                cases.push(item);
            }
            return cases;
        }

        /** สร้างแถวตาราง HTML จากข้อมูลคดีที่ถูกกรองแล้ว */
        function renderCasesTable(cases) {
            casesTableBody.innerHTML = ''; 
            if (cases.length === 0) {
                const noResultsRow = `<tr class="no-results"><td colspan="5" style="text-align: center;">ไม่พบข้อมูลคดีที่ตรงกับคำค้นหา</td></tr>`;
                casesTableBody.insertAdjacentHTML("beforeend", noResultsRow);
                return;
            }

            cases.forEach(c => {
                const row = `<tr>
                    <td>${c["เลขคดีดำ"] || "-"}</td>
                    <td>${c["ปีคดีดำ"] || "-"}</td>
                    <td>${c["ผู้ฟ้องคดี"] || "-"}</td>
                    <td>${c["ผลของคำพิพากษา"] || "-"}</td>
                    <td>${c["สถานะคดี"] || "-"}</td>
                </tr>`;
                casesTableBody.insertAdjacentHTML("beforeend", row);
            });
        }

        /** กรองและแสดงผลคดีตามคำค้นหา */
        function filterAndRenderCases() {
            const searchTerm = caseSearchInput.value.trim().toLowerCase();
            let filteredCases = [];
            
            if (searchTerm.length === 0) {
                // แสดง 10 คดีล่าสุด (เรียงตามลำดับการเพิ่มใน Google Sheet ซึ่งคือ Index ท้ายๆ)
                filteredCases = allCasesData.slice(-10).reverse();
                tableTitle.innerText = "10 คดีล่าสุดที่อัปเดต";
            } else {
                filteredCases = allCasesData.filter(c => 
                    // กรองตาม เลขคดีดำ หรือ ปีคดีดำ (แปลงเป็น string ก่อน)
                    (c["เลขคดีดำ"] && String(c["เลขคดีดำ"]).toLowerCase().includes(searchTerm)) ||
                    (c["ปีคดีดำ"] && String(c["ปีคดีดำ"]).toLowerCase().includes(searchTerm))
                );
                tableTitle.innerText = `ผลการค้นหาคดี: "${caseSearchInput.value.trim()}" (${filteredCases.length} คดี)`;
            }

            renderCasesTable(filteredCases);
        }
        
        caseSearchInput.addEventListener('input', filterAndRenderCases);


        /** ประมวลผลและแสดงผล Dashboard ทั้งหมด */
        function processAndRenderDashboard(values) {
            if (!values) return;

            const cases = arrayToObjects(values);
            allCasesData = cases; 

            // 1. คำนวณสถานะคดี
            const totalCases = cases.length;
            
            // คำนวณตามสถานะที่มีใน Data
            const firstCourtCases = cases.filter(c => c["สถานะคดี"].includes("ชั้นต้น")).length;
            const supremeCourtCases = cases.filter(c => c["สถานะคดี"].includes("สูงสุด")).length;
            const inExecutionCases = cases.filter(c => c["สถานะคดี"].includes("อยู่ในขั้นตอนบังคับคดี") || c["สถานะคดี"].includes("ระหว่างบังคับคดี")).length;
            const executionCompleteCases = cases.filter(c => c["สถานะคดี"].includes("บังคับคดีเสร็จสิ้น")).length;
            const finalCases = cases.filter(c => c["สถานะคดี"].includes("ถึงที่สุด")).length; // คำพิพากษาถึงที่สุด

            // 2. อัปเดตตัวเลขในการ์ด
            document.getElementById("totalCases").innerText = totalCases.toLocaleString('th-TH');
            document.getElementById("finalCases").innerText = finalCases.toLocaleString('th-TH');
            document.getElementById("firstCourtCases").innerText = firstCourtCases.toLocaleString('th-TH');
            document.getElementById("supremeCourtCases").innerText = supremeCourtCases.toLocaleString('th-TH');
            document.getElementById("executionCompleteCases").innerText = executionCompleteCases.toLocaleString('th-TH');
            document.getElementById("inExecutionCases").innerText = inExecutionCases.toLocaleString('th-TH');

            // 3. สร้าง Pie Chart
            const ctx = document.getElementById("caseStatusChart");
            if (chartInstance) { chartInstance.destroy(); } // ทำลาย instance เก่าก่อน

            const chartData = {
                labels: ["คำพิพากษาถึงที่สุด", "อยู่ระหว่างพิจารณาชั้นต้น", "อยู่ระหว่างพิจารณาสูงสุด", "อยู่ในขั้นตอนบังคับคดี", "บังคับคดีเสร็จสิ้น"],
                datasets: [{
                    label: "จำนวนคดี",
                    data: [finalCases, firstCourtCases, supremeCourtCases, inExecutionCases, executionCompleteCases],
                    backgroundColor: ["#4CAF50", "#2196F3", "#FFC107", "#FF8C00", "#008080"],
                    borderColor: "white",
                    borderWidth: 2
                }]
            };
            
            chartInstance = new Chart(ctx, {
                type: "pie",
                data: chartData,
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            display: true, 
                            position: 'right', 
                            labels: { font: { family: "Sarabun" } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += new Intl.NumberFormat('th-TH').format(context.parsed) + ' คดี';
                                    }
                                    return label;
                                }
                            },
                            titleFont: { family: "Sarabun", size: 14 },
                            bodyFont: { family: "Sarabun", size: 12 }
                        }
                    },
                }
            });

            // 4. แสดงผลตารางเริ่มต้น
            filterAndRenderCases(); 
        }

    </script>
</body>
</html>
