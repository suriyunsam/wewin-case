<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard สถานะคดีปกครอง</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ใช้ Tailwind/Custom CSS สำหรับความสวยงามและการปรับตามอุปกรณ์ */
    body {
      font-family: "Sarabun", sans-serif;
      background-color: #f7f9fb;
      margin: 0;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      max-width: 1200px;
      width: 100%;
      padding: 10px;
    }
    h1 {
      color: #1b365d;
      text-align: center;
      margin-bottom: 25px;
      font-size: 1.8rem;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
      gap: 12px;
      margin-bottom: 25px;
    }
    .card {
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      text-align: center;
      border-left: 6px solid; 
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-3px);
    }
    
    /* สี Border ตามสถานะ */
    #totalCasesCard { border-color: #1b365d; }
    #firstCourtCasesCard { border-color: #2196F3; }
    #supremeCourtCasesCard { border-color: #FFC107; }
    #finalJudgementCasesCard { border-color: #4CAF50; }
    #enforcementInProgressCasesCard { border-color: #FF9800; }
    #enforcementCompleteCasesCard { border-color: #009688; }

    .card h3 {
      font-size: 0.85em;
      margin: 0 0 5px;
      color: #6b7280; /* Gray-500 */
    }
    .card h2 {
      font-size: 1.7em;
      margin: 5px 0;
      color: #1b365d;
      font-weight: 700;
    }
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }
    h2 {
      color: #1b365d;
      margin-top: 0;
      font-size: 1.5rem;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 5px;
      margin-bottom: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    th, td {
      padding: 12px 10px;
      border-bottom: 1px solid #eee;
      text-align: left;
      font-size: 0.9em;
    }
    th {
      background: #1b365d;
      color: white;
      font-weight: 700;
    }
    tbody tr:hover {
        background-color: #f0f4f8;
    }
    .error-box {
        background-color: #fee2e2;
        color: #b91c1c;
        border: 1px solid #fca5a5;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        font-weight: bold;
    }

    /* Mobile Responsiveness */
    @media (max-width: 600px) {
        .dashboard {
            grid-template-columns: repeat(2, 1fr);
        }
        h1 {
            font-size: 1.5rem;
        }
        th, td {
            padding: 8px 5px;
            font-size: 0.8em;
        }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📊 ระบบติดตามสถานะคดีปกครอง</h1>
    <div id="statusMessage"></div> <!-- ใช้แสดงข้อความแจ้งเตือน/ข้อผิดพลาด -->

    <div class="dashboard">
      <div class="card" id="totalCasesCard">
        <h3>คดีรวมทั้งหมด</h3>
        <h2 id="totalCases">-</h2>
      </div>
      <div class="card" id="firstCourtCasesCard">
        <h3>ระหว่างพิจารณา (ศาลชั้นต้น)</h3>
        <h2 id="firstCourtCases">-</h2>
      </div>
      <div class="card" id="supremeCourtCasesCard">
        <h3>ระหว่างพิจารณา (ศาลสูงสุด)</h3>
        <h2 id="supremeCourtCases">-</h2>
      </div>
      <div class="card" id="finalJudgementCasesCard">
        <h3>คำพิพากษาถึงที่สุดแล้ว</h3>
        <h2 id="finalJudgementCases">-</h2>
      </div>
      <div class="card" id="enforcementInProgressCasesCard">
        <h3>ระหว่างขั้นตอนการบังคับคดี</h3>
        <h2 id="enforcementInProgressCases">-</h2>
      </div>
      <div class="card" id="enforcementCompleteCasesCard">
        <h3>บังคับคดีเสร็จสิ้น</h3>
        <h2 id="enforcementCompleteCases">-</h2>
      </div>
    </div>

    <div class="chart-container">
      <h2>สรุปสถานะคดี</h2>
      <canvas id="caseStatusChart"></canvas>
    </div>

    <h2>📁 รายการคดีล่าสุด (10 คดี)</h2>
    <div style="overflow-x: auto;">
      <table id="casesTable">
        <thead>
          <tr>
            <th>เลขคดีดำ</th>
            <th>ศาล</th>
            <th>ผู้ฟ้องคดี</th>
            <th>สถานะคดี</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // **********************************************
    // ⚠️ กำหนดค่า Google Sheet API ⚠️
    // **********************************************
    // 1. **SHEET ID**: ID ของ Google Sheet (จาก URL)
    const sheetId = "wewin-case";  // ตัวอย่างของคุณ
    
    // 2. **API KEY**: Google Cloud API Key (ต้องเปิด Sheets API และอนุญาต Referrer)
    const API_KEY_PLACEHOLDER = "AIzaSyCPsgQyhXD28bNQOu-sKPaXxzdoPlyTXHw";
    // ⚠️ กรุณาแทนที่ YOUR_API_KEY_HERE ด้วยคีย์จริงของคุณ ⚠️
    const apiKey = API_KEY_PLACEHOLDER; 
    
    // 3. **Range**: ช่วงของข้อมูล (ใช้ A:M เพื่อครอบคลุมทั้งคอลัมน์)
    const range = "A:M";
    
    // 4. ชื่อ Sheet: ต้องตรงกับชื่อชีตในไฟล์ Google Sheet (ค่าเริ่มต้นคือ Sheet1)
    const sheetName = "Sheet1"; 
    
    // URL สำหรับเรียก Google Sheets API
    const sheetUrl = `https://sheets.googleapis.com/v4/spreadsheets/${wewin-case}/values/${"ฐานข้อมูลสถานะคดีปกครอง"}!${A:M}?key=${AIzaSyCPsgQyhXD28bNQOu-sKPaXxzdoPlyTXHw}`;

    // ฟังก์ชันแสดงข้อความผิดพลาดบน UI
    const displayError = (message) => {
        document.getElementById("statusMessage").innerHTML = `<div class="error-box">⚠️ ${message} </div>`;
        // ตั้งค่าการ์ดเป็น Error
        document.getElementById("totalCases").innerText = "---";
    }

    // ตรวจสอบ API Key Placeholder
    if (apiKey === API_KEY_PLACEHOLDER) {
        displayError("กรุณาแทนที่ 'YOUR_API_KEY_HERE' ด้วย API Key จริงของคุณ");
    } else {
        fetchDataAndRenderDashboard();
    }

    // ฟังก์ชันหลักในการดึงข้อมูลและแสดงผล
    function fetchDataAndRenderDashboard() {
        // console.log("Attempting to fetch data from URL:", sheetUrl);

        // ฟังก์ชันสำหรับคำนวณสรุปข้อมูล
        const calculateCaseSummary = (cases) => {
            const statusMap = {
                // ใช้ toUpperCase() เพื่อความมั่นใจในการเปรียบเทียบ
                firstCourtCases: (status) => status && status.includes("ชั้นต้น") && !status.includes("สูงสุด") && !status.includes("ถึงที่สุด"),
                supremeCourtCases: (status) => status && status.includes("สูงสุด") && !status.includes("ถึงที่สุด") && !status.includes("บังคับคดี"),
                finalJudgementCases: (status) => status && status.includes("ถึงที่สุด") && !status.includes("บังคับคดี"),
                enforcementInProgressCases: (status) => status && status.includes("ระหว่างบังคับคดี") && !status.includes("เสร็จสิ้น"),
                enforcementCompleteCases: (status) => status && status.includes("บังคับคดีเสร็จสิ้น")
            };

            const summary = { totalCases: cases.length };

            for (const key in statusMap) {
                summary[key] = cases.filter(c => {
                    const status = c["สถานะคดี"] ? c["สถานะคดี"].toLowerCase() : "";
                    return statusMap[key](status);
                }).length;
            }
            return summary;
        }
        
        // ฟังก์ชันอัปเดต Dashboard (KPI Cards)
        const updateDashboard = (summary) => {
            document.getElementById("totalCases").innerText = summary.totalCases;
            document.getElementById("firstCourtCases").innerText = summary.firstCourtCases;
            document.getElementById("supremeCourtCases").innerText = summary.supremeCourtCases;
            document.getElementById("finalJudgementCases").innerText = summary.finalJudgementCases;
            document.getElementById("enforcementInProgressCases").innerText = summary.enforcementInProgressCases;
            document.getElementById("enforcementCompleteCases").innerText = summary.enforcementCompleteCases;
        }

        // ฟังก์ชันแสดงกราฟ
        const renderChart = (summary) => {
            const ctx = document.getElementById("caseStatusChart");
            const chartData = {
              labels: ["พิจารณา (ชั้นต้น)", "พิจารณา (สูงสุด)", "ถึงที่สุดแล้ว", "ระหว่างบังคับคดี", "บังคับคดีเสร็จสิ้น"],
              datasets: [{
                label: "จำนวนคดี",
                data: [
                  summary.firstCourtCases, 
                  summary.supremeCourtCases, 
                  summary.finalJudgementCases, 
                  summary.enforcementInProgressCases, 
                  summary.enforcementCompleteCases
                ],
                backgroundColor: ["#2196F3", "#FFC107", "#4CAF50", "#FF9800", "#009688"]
              }]
            };
            
            if (window.caseStatusChart) {
                window.caseStatusChart.destroy(); 
            }

            window.caseStatusChart = new Chart(ctx, {
              type: "bar",
              data: chartData,
              options: { 
                responsive: true, 
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
              }
            });
        }

        // เริ่มต้นดึงข้อมูล
        fetch(sheetUrl)
          .then(res => {
            if (!res.ok) {
                // อ่านข้อความผิดพลาดจาก body เพื่อให้ข้อความละเอียดขึ้น
                return res.json().then(error => {
                    const errorMessage = error.error?.message || `HTTP Status: ${res.status}`;
                    throw new Error(errorMessage);
                });
            }
            return res.json();
          })
          .then(data => {
            const rows = data.values;
            if (!rows || rows.length < 2) {
                displayError("ไม่พบข้อมูล หรือมีข้อมูลไม่เพียงพอ โปรดตรวจสอบช่วงข้อมูล (Range)");
                return;
            }
            if (!rows[0].includes("สถานะคดี") || !rows[0].includes("เลขคดีดำ")) {
                displayError("โครงสร้างข้อมูลผิดพลาด: ตรวจสอบว่ามีหัวข้อ 'สถานะคดี', 'เลขคดีดำ' ในแถวแรก");
                return;
            }

            const headers = rows[0];
            // เปลี่ยนชื่อตัวแปร 'cases' เป็น 'caseRecords' เพื่อหลีกเลี่ยง Syntax Error 'Unexpected token case'
            const caseRecords = rows.slice(1)
              .filter(r => r.some(cell => cell)) // กรองแถวที่ว่างทั้งหมด
              .map(r => Object.fromEntries(headers.map((h, i) => [h, r[i]])));
            
            const caseSummary = calculateCaseSummary(caseRecords);
            
            updateDashboard(caseSummary);
            renderChart(caseSummary);

            // ตารางคดีล่าสุด (10 คดีสุดท้าย)
            const tbody = document.querySelector("#casesTable tbody");
            tbody.innerHTML = "";
            caseRecords.slice(-10).reverse().forEach(c => {
              const row = `<tr>
                <td>${c["เลขคดีดำ"] || "-"}</td>
                <td>${c["ศาล"] || "-"}</td>
                <td>${c["ผู้ฟ้องคดี"] || "-"}</td>
                <td>${c["สถานะคดี"] || "-"}</td>
              </tr>`;
              tbody.insertAdjacentHTML("beforeend", row);
            });
          })
          .catch(err => {
              console.error("Fetch Data Failed:", err);
              displayError(`การเชื่อมต่อล้มเหลว: ${err.message}. โปรดตรวจสอบ Console Log (F12) เพื่อดูรายละเอียด`);
          });
    }
  </script>
</body>
</html>
